mkdir -p ~/docker-gui/9-virtual-desktops/Xephyr
cd ~/docker-gui/9-virtual-desktops/Xephyr



nano Dockerfile




FROM ubuntu:18.04

RUN apt-get update && DEBIAN_FRONTEND=noninteractive \
    apt-get install -y --no-install-recommends \
    xserver-xephyr && \
    rm -rf /var/lib/apt/lists/*

ENTRYPOINT ["Xephyr"]








docker build -t xephyr .







cd ~/docker-gui/9-virtual-desktops/Xephyr





nano xephyr.sh






#!/bin/bash

# The X11 DISPLAY number of the nested Xephyr X server.
# Accepts user input value or defaults to :1
NESTED_DISPLAY=${@:-:1}

# Adjust BIN to point to the helper script directory
BIN=$(cd $(dirname $0); echo ${PWD%docker-gui*})docker-gui/bin

# Source X11 and Docker helper logic
. $BIN/docker-xauth.sh
. $BIN/docker-command.sh

# Run the Xephyr container
$DOCKER_COMMAND run --rm \
    --ipc=host \
    -u $(id -u):$(id -g) \
    -v /etc/passwd:/etc/passwd:ro \
    $X11_FLAGS_RW \
    xephyr $NESTED_DISPLAY -resizeable -ac -reset -terminate 2> /dev/null









chmod +x xephyr.sh









mkdir -p ~/docker-gui/bin
cd ~/docker-gui/bin






nano docker-xauth.sh









#!/bin/bash

DOCKER_XAUTHORITY=/tmp/.docker.xauth

if [ ! -f $DOCKER_XAUTHORITY ]; then
    touch $DOCKER_XAUTHORITY
    xauth nlist $DISPLAY | sed -e 's/^..../ffff/' | xauth -f $DOCKER_XAUTHORITY nmerge -
fi

X11_FLAGS_RW="-e DISPLAY=$DISPLAY -v $DOCKER_XAUTHORITY:/root/.Xauthority:rw -v /tmp/.X11-unix:/tmp/.X11-unix:rw"






chmod +x docker-xauth.sh









nano docker-command.sh



#!/bin/bash

DOCKER_COMMAND="docker"





chmod +x docker-command.sh






cd ~/docker-gui/9-virtual-desktops/Xephyr



./xephyr.sh







mkdir -p ~/docker-gui/9-virtual-desktops/debian-buster-lxde
cd ~/docker-gui/9-virtual-desktops/debian-buster-lxde






nano Dockerfile






FROM debian:buster

ENV DEBIAN_FRONTEND=noninteractive

# Replace old repositories with archive.debian.org and allow expired metadata
RUN echo "deb http://archive.debian.org/debian buster main contrib non-free" > /etc/apt/sources.list && \
    echo "deb http://archive.debian.org/debian-security buster/updates main" >> /etc/apt/sources.list && \
    echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        dbus-x11 lightdm slick-greeter \
        lxde lxterminal lxsession lxappearance lxinput lxrandr \
        synaptic policykit-1 x11-xserver-utils \
        locales tzdata xinit xserver-xephyr \
        systemd systemd-sysv sudo console-setup \
        desktop-base \
        x11-utils x11-xkb-utils xfonts-base x11-xfs-utils \
        x11-common x11-session-utils x11-xkb-utils \
        gnome-icon-theme gnome-themes-standard \
        pulseaudio alsa-utils \
        mousepad \
    && apt-get clean

# Fix Synaptic slowness (due to Docker compressing index files)
RUN rm /etc/apt/apt.conf.d/docker-gzip-indexes

# Set locale and timezone
RUN echo "en_US.UTF-8 UTF-8" > /etc/locale.gen && \
    locale-gen && \
    ln -fs /usr/share/zoneinfo/Etc/UTC /etc/localtime && \
    dpkg-reconfigure -f noninteractive tzdata

# Remove conflicting .desktop files to ensure correct LightDM session
RUN rm -f /usr/share/xsessions/lightdm-xsession.desktop /usr/share/xsessions/openbox.desktop

# Xephyr LightDM wrapper script
RUN echo '#!/bin/bash\n\
export XAUTHORITY=/root/.Xauthority.docker\n\
export DISPLAY=:0\n\
exec Xephyr $1 -ac -dpi 48 >> /var/log/lightdm/x-1.log' > /usr/bin/Xephyr-lightdm-wrapper && \
    chmod +x /usr/bin/Xephyr-lightdm-wrapper

# Configure LightDM to use Xephyr
RUN echo '[LightDM]\n\
minimum-display-number=1\n\
[Seat:*]\n\
session-setup-script=sh -c "xdpyinfo | grep -q RANDR && exec xrandr --output default --mode 1600x1200 || true"\n\
greeter-hide-users=false\n\
xserver-command=/usr/bin/Xephyr-lightdm-wrapper' > /etc/lightdm/lightdm.conf

# Set LightDM as systemd default display manager
RUN rm -f /etc/systemd/system/display-manager.service && \
    ln -s /lib/systemd/system/lightdm.service /etc/systemd/system/display-manager.service && \
    echo '/usr/sbin/lightdm' > /etc/X11/default-display-manager

# Set greeter background to Debian theme
RUN echo '[Greeter]\n\
background=/usr/share/desktop-base/futureprototype-theme/plymouth/plymouth_background_future.png' > /etc/lightdm/slick-greeter.conf

# Configure console font and character set
RUN echo "console-setup console-setup/charmap select UTF-8" | debconf-set-selections

# Fix Synaptic error "_cache->open() failed"
RUN sed -i 's/Dir::Cache::pkgcache "";//' /etc/apt/apt.conf.d/docker-clean || true

# Disable getty on tty1 (quicker boot, avoids session errors)
RUN rm -f /etc/systemd/system/getty.target.wants/getty@tty1.service

# Speed up shutdown by reducing systemd timeout
RUN sed -i 's/#DefaultTimeoutStopSec=90s/DefaultTimeoutStopSec=5s/' /etc/systemd/system.conf

# Allow container sessions to shutdown/reboot
RUN chmod 755 /etc/polkit-1/localauthority && \
    echo '[Shutdown & Restart]\n\
Identity=unix-user:*\n\
Action=org.freedesktop.login1.power-off;org.freedesktop.login1.power-off-multiple-sessions;org.freedesktop.login1.reboot;org.freedesktop.login1.reboot-multiple-sessions\n\
ResultAny=yes\n\
ResultInactive=yes\n\
ResultActive=yes' > /etc/polkit-1/localauthority/50-local.d/10-shutdown.pkla

CMD ["/sbin/init"]





docker build -t debian-lxde:buster .







nano ~/docker-gui/9-virtual-desktops/debian-buster-lxde/make-credentials.sh





#!/bin/bash
set -e

IMAGE=debian-lxde:buster
CONTAINER=debian-lxde-setup

echo "Creating /etc/passwd /etc/shadow and /etc/group for container."

docker rm -f $CONTAINER 2>/dev/null || true

docker run -d --name $CONTAINER $IMAGE sleep 5

docker exec $CONTAINER adduser --disabled-password --gecos "" user

mkdir -p root

docker cp $CONTAINER:/etc/passwd root/passwd
docker cp $CONTAINER:/etc/shadow root/shadow
docker cp $CONTAINER:/etc/group  root/group

tar -C root -czf etc.tar.gz passwd shadow group

docker rm -f $CONTAINER















chmod +x make-credentials.sh


./make-credentials.sh










mkdir -p ~/$(id -un)





nano ~/docker-gui/9-virtual-desktops/debian-buster-lxde/launch.sh




#!/bin/bash

set -e

DOCKER_COMMAND=docker
IMAGE=debian-lxde:buster
CONTAINER=debian-lxde

# Create home directory if not present
mkdir -p $(id -un)

# Launch container
$DOCKER_COMMAND run --rm -d \
  --device=/dev/tty0 \
  --name $CONTAINER \
  --ipc=host \
  --shm-size 2g \
  --security-opt apparmor=unconfined \
  --cap-add=SYS_ADMIN --cap-add=SYS_BOOT \
  -v /sys/fs/cgroup:/sys/fs/cgroup \
  -v $PWD/$(id -un):/home/$(id -un) \
  -v $PWD/../bin/docker-xauth.sh:/usr/local/bin/docker-xauth.sh:ro \
  -v $PWD/../bin/docker-command.sh:/usr/local/bin/docker-command.sh:ro \
  -v $PWD/../../Xephyr/xephyr.sh:/usr/local/bin/xephyr.sh:ro \
  -v $HOME/.Xauthority:/root/.Xauthority.docker:ro \
  -v /tmp/.X11-unix/X0:/tmp/.X11-unix/X0:ro \
  $IMAGE /sbin/init

# Wait briefly to ensure the container is ready
sleep 0.25

# Copy credential files into the container
cat etc.tar.gz | $DOCKER_COMMAND cp - $CONTAINER:/




chmod +x ~/docker-gui/9-virtual-desktops/debian-buster-lxde/launch.sh



./launch.sh




./make-credentials.sh
























